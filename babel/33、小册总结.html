<style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><p>不管是业务开发，还是做提效工具，基本都离不开编译，而市面上的文章大多都停留在 preset 使用上，并没有系统的深入讲解 babel 插件的教程，而官方的插件文档内容太少，也没有具体案例，所以我才想写这本小册。</p>
<p>标题定为“通关秘籍”，这也是我写小册的初衷，一定要把 babel 讲透。我觉得任何一个技术只有学习到一定的程度才是有意义的，让它化为你思想的一部分，而不是只是使用。只是使用没啥竞争力。</p>
<p>怎么通关呢？我这样设计了小册的内容：</p>
<p>先讲 babel 是什么，能做什么，然后讲 babel 编译流程，之后介绍下 AST 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://astexplorer.net/" ref="nofollow noopener noreferrer">astexperer.net</a> 这个工具，然后介绍各个包的 api。</p>
<p>前几节过了一遍这些内容之后，需要先来个实战案例感受下，所以后面是“插入函数调用参数”的一个案例，功能比较简单，但是却把 api、AST、编译流程等做了串联。</p>
<p>之后的章节是深入讲解每一部分了，包括 parser 的历史，梳理清楚各种 AST 的关联，acorn parser 是如何扩展的；visitor 的设计模式，path 和 path.scope 的各种 api 的讲解；generate 的原理和 sourcemap 的原理、code-frame 是怎么拼接的，控制台是如何实现代码高亮的；</p>
<p>这些深入的内容难度大一些，确实深入掌握 babel 必须要走的路。</p>
<p>之后介绍了 babel 插件和 preset 怎么写，单元测试怎么写，为后面实战案例做铺垫。</p>
<p>大多数人还是使用 babel 提供的 preset 等，于是花了两节介绍了插件的分类（transform、syntax 插件）， babel 从babel6 的 preset-es20xx 到  babel7 的 preset-env 都做了啥改变，为什么要这样做，都解决了什么问题。为什么要有 transform-runtime 插件，还介绍了 babel8 的 polyfill provider 等。</p>
<p>babel 主要的功能都是基于插件提供了一层 preset，这是一种门面模式，简化开发者使用 babel 的成本。我们使用 babel 的话，学习下 preset-env 即可。</p>
<p>后面就是各种实战案例了，其实这些案例小册里实现比较简单，更多是为了理清思路，但这些都是真实的很多大厂在用的方案，包括自动函数插桩、自动国际化、自动生成文档等。这些思路是通用思路，学会了很容易可以用在项目里，成为简历的亮点和拿绩效的抓手。</p>
<p>之后我们实现了下 linter、type chekcer、压缩混淆，这些都是分析和转换代码的工具，目的是为了让大家理解 eslint、typescript、terser 的实现原理。同样，目的是为了打通思路，案例并不是完善的实现。</p>
<p>模块遍历器则是打包工具的基础，打包工具离不开模块的依赖分析和遍历，遍历之后构建依赖图，之后对每个依赖进行编译，最后合并到一块来输出目标文件。遍历 AST 是要确定什么属性，遍历模块则是要解析 require，然后处理路径，这两者也是有关联的。这一节的设计是为了帮助大家了解下打包工具用编译技术做了啥事情。</p>
<p>js 解释器则是为了让大家理解 js 引擎的原理，我们实现了一个 tree walker 解释器，是用 js 实现的，如果用 c++ 按照同样的思路实现，就可以是一个小型的 v8 或者 quickjs 这种引擎了。当然，现在大多 js 引擎都是编译成字节码再解释，而不是直接解释 AST，但只是多了一层转换，解释的本质不变。</p>
<p>babel macros 是这几年的一个概念，主要是可以在代码里面插入 macro 来配置转换哪里的代码，这个是基于 babel-macro-plugin 实现的。相比 babel plugin 只不过是从全局的 visitor 搜索到具体节点，变成了从具体节点向上找，形式不一样，但是 api 是一样的，会了 babel 的基础很容易也就掌握 macro 了。</p>
<p>说要通关，不实现一个 babel 怎么算通关呢？</p>
<p>所以后面我们实现了 babel 的编译内核，包括 parser、traverse、generator，以及 types、template 还有 core、cli，这样就把编译流程和 api、cli 两种接口的实现思路都打通了。</p>
<p>babel 的各种 preset 只不过是基于插件的封装，这些东西是变化的，比如preset-env 通过 browsewrslist 来指定运行环境，然后基于插件和运行环境版本的对应关系的数据库来动态引入插件，最终做的事情还是插件做的，基于的内核都是一样的，只不过 preset 的封装使得 babel 更易用了。</p>
<p>babel 的preset 是一直变的，但是编译内核和插件基本没啥变化，理清变与不变，抓住本质来学。</p>
<p>helper 是插件的工具函数，runtime 包包括 helper、regenerator、corejs 这些是 babel 做 polyfill 需要的，这些都是第三方实现的，babel 是借助了它们来实现 polyfill 功能。babel8 还支持了 polyfill 的切换，也就是 polyfill provider 功能。</p>
<p>调试 babel 插件最好的方式永远是 debugger，但这个技能大部分人不会用，所以单独加了一节来介绍 vscode debugger 的原理和使用，帮助大家把这个调试利器用起来。</p>
<p>小册写了比较长的时间，因为比较浅的掌握是容易的，但是想深入就没那么容易了，基本都要看源码和大量的实验。但是就像开头说的那样，任何一门技术只有学到一定的深度，化为自己思想的一部分才是意义比较大的。浅尝辄止其实没啥作用。</p>
<p>而且很多技术都是通的，比如 browserslist 来动态指定插件的思路，在 postcss 中也用到了，而 sourcemap 的原理各种编译打包工具都一样，当你能实现sourcemap 了，那掌握各种工具的 sourcemap 使用易如反掌。</p>
<p>前端的编译工具都是源码转源码，更直白点说都是字符串转字符串，只不过中间要理解代码需要 parse 成 AST，把对字符串的操作转为对 AST 的操作，而不是直接用正则修改字符串，这种转换其实各种工具都差不多，比如 eslint、terser、typescript、postcss、stylelint、swc 等等，小册中也实现了一下，大家应该能感受到。所以，学习完 babel 插件之后，再去学别的工具的插件也会简单很多，只是学习下不同的封装形式和 api 即可。</p>
<p>小册到这里就算结束了，希望像这本小册的标题一样，帮助大家真正的通关 babel ！</p>
<p>前端编译相关技术，Babel 并不是结束，关于后续计划，可以查看
<a href="https://juejin.cn/post/7009257446354976781/" target="_blank" title="https://juejin.cn/post/7009257446354976781/">谈谈我关于前端编译的梦想</a></p>
<p>扩展阅读：</p>
<p>用编译技术实现覆盖率检测： <a href="https://juejin.cn/post/7019161146347388959" target="_blank" title="https://juejin.cn/post/7019161146347388959">juejin.cn/post/701916…</a></p>
<p>用 babel 插件实现 import 方式转换：
<a href="https://juejin.cn/post/7018563244679757855" target="_blank" title="https://juejin.cn/post/7018563244679757855">juejin.cn/post/701856…</a></p><style>.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>