<style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><blockquote>
<p>想看懂复杂代码离不开 debugger，它是提升 Node.js 水平必备的能力。因为后面的案例代码都是有一定的复杂度的，建议同学们先学会使用 debugger 再去学后面的案例，结合 debugger 来看。</p>
</blockquote>
<p>这一节，我们来学习下 vscode debugger 的使用。</p>
<p>首先，同学们把<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fbabel-plugin-exercize" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/babel-plugin-exercize" ref="nofollow noopener noreferrer">代码</a>下载下来后，可以看到又一个 .vscode 的目录，里面有个 launch.json 的配置，这里面就是调试的配置。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d04026afef6d4761ac4ff3dcf5d2f84d~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这个文件就是调试的配置，点开 debugger 的窗口，就可以看到启动调试的按钮。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/205267d73fbc4e7dab7d76c9992b6a97~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>可以在想断住的那一行左边点一下，就会打上断点，然后点击调试，就会以 debug 模式运行，到了断点就会停住，然后可以看到堆栈信息、断点等。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbd7b6f296ea4235825cea8bda6b84c5~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这是 vscode debugger 的使用方式。</p>
<h2 data-id="heading-0">vscode debugger 的配置</h2>
<p>会了怎么使用之后，我们来深入讲下怎么配置，希望能够让同学们的 nodejs 调试能力有所提升。</p>
<p>点击这个齿轮，会打开 .vscode/launch.json 的内容来编辑，在这里写各种配置。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6bfb71747d254624913047f5819c45a5~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>点击右下角的按钮就会有一个菜单来选择配置的模版：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/73942b78943f498fa4eb2190ca78e510~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>运行环境有很多，比如 chrome、node.js 等，这里我们只需要 node.js 的环境。</p>
<p>然后启动方式分为 launch 和 attach 两种。为什么是这两种呢？</p>
<p>那是因为调试是分为客户端和服务端的，</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e25d1a7e7114b1497558a18f3219ea2~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>我们如果是启动 node.js 的调试模式，需要加上 --inspect  或者 --inspect-brk（在首行断住）参数，之后会启动一个 websocket server，等待客户端链接。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ff979331b7046faa1a0dc3a6ce28397~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>两者之间是通过 v8 debug protocol 来通信的。</p>
<p>比如：
设置断点：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-string">"seq"</span>:<span class="hljs-number">117</span>,
    <span class="hljs-string">"type"</span>:<span class="hljs-string">"request"</span>,
    <span class="hljs-string">"command"</span>:<span class="hljs-string">"setbreakpoint"</span>,
    <span class="hljs-string">"arguments"</span>:{
        <span class="hljs-string">"type"</span>:<span class="hljs-string">"function"</span>,
        <span class="hljs-string">"target"</span>:<span class="hljs-string">"f"</span>
    }
}
</code></pre>
<p>去掉断点：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-string">"seq"</span>:<span class="hljs-number">117</span>,
    <span class="hljs-string">"type"</span>:<span class="hljs-string">"request"</span>,
    <span class="hljs-string">"command"</span>:<span class="hljs-string">"clearbreakpoint"</span>,
    <span class="hljs-string">"arguments"</span>: {
        <span class="hljs-string">"type"</span>:<span class="hljs-string">"function"</span>,
        <span class="hljs-string">"breakpoint"</span>:<span class="hljs-number">1</span>
     }
}
</code></pre>
<p>手动连接的话可以打开 chrome://inspect 页面，可以用 chrome devtools 的 debugger client 连上来调试。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d72a6152fe1402ca424a7c02d530c9f~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/21ba7e5435b14b798581401553c4d89f~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>但是，用 vscode 不用这么麻烦，直接在 .vscode/launch.json 里面配置下就可以。</p>
<p>前面提到 vsocde 的 debug 配置分为 launch 和 attach 两种：</p>
<ul>
<li>launch： 把 nodejs 代码跑起来，启动 debugger server，然后用 client 来连接</li>
<li>attach：已经有了 debugger server，只需要启动一个 debugger client 连接上就行</li>
</ul>
<p>所以就可以看到 launch 的配置要指定运行什么 js 代码：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6aaf1a267e224baaa09704e8a2263a82~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>而 attach 则只需要指定 连接到哪个端口：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e047d1180ea44589147859fcfd0bd92~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>当然，小册里的代码都通过 launch 的配置就可以，如果添加的话也是类似上面的方式添加调试配置，然后就可以调试了。</p>
<p>vscode 提供了这几个控制按键（底层会发送 debug 协议的消息），点击按钮就可以让代码继续运行。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e3dbcb4cd2a4f39b1d433bff2cf58ff~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>第一个是继续运行，到下一个断点停住</p>
<p>第二个是运行下一步（单步运行）</p>
<p>第三个可以在执行到某个函数调用的时候进入函数内部执行</p>
<p>第四个是跳出当前函数调用，然后往下执行</p>
<p>第五个是重新运行</p>
<p>第六个是终止运行</p>
<p>学会了 debugger 以后，api 不用记，打个断点都能看到：
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/408207297a514949b7b83ad0457ceedb~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3699f18e54404278a6cc6f6ececd4029~tplv-k3u1fbpfcp-watermark.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<h2 data-id="heading-1">总结</h2>
<p>debug 能力是一种很重要的能力，比起 console.log 来能精确的知道每一步的运行结果，更容易读懂代码。</p>
<p>小册代码中有 vscode debugger 的配置，但是很多读者不会使用，所以这节来介绍了一下，主要是在 .vscode/launch.json 里面添加配置，然后在 debug 窗口来启动调试，之后就可以打断点和单步运行了。</p>
<p>vscode debugger 的使用分为这几步：</p>
<ol>
<li>在 .vscode/launch.json 里面添加对应 js 文件的调试配置</li>
<li>在要调试的那行左边打断点</li>
<li>点击调试窗口的调试按钮启动调试</li>
<li>点击下一步、下一个断点、进入函数内部等方式来部分执行代码</li>
</ol>
<p>其实 debugger 主要是分为一个 debugger server 和一个 debugger client，deubgger server 在 js 引擎里面，debugger client 包括 chrome devtools、vscode debugger 等，他们两者之间通过调试协议通信，比如 v8 debug protocol。</p>
<p>launch 的方式就是启动一个 debugger server（websocket），然后用 debugger client 连接上，发送消息来控制单步执行、打断点等。</p>
<p>而 attach 只是 启动 client，连上已有的 debugger server，后续流程一样。</p>
<p>node --inspect xxx.js 就可以看到 ws://sss:111 的地址，这就是 websocket 的 debugger server 的地址。客户端用 chrome. devtools. 可以，用 vscode 或者其他 ide 都可以，因为他们都实现了 v8 debug protocol 的 websocket client，只是做了各自的 ui。（当然，原理做了解即可，了解原理的目的是为了更好的使用工具）。</p>
<p>希望同学们能掌握 vscode debugger 的使用，对更好的理解案例代码有很大的帮助。</p><style>.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>